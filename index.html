<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Wanderer</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    
    .game-font { font-family: 'Press Start 2P', monospace; }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .float-anim { animation: float 2s ease-in-out infinite; }
    .pulse-anim { animation: pulse 1s ease-in-out infinite; }
    .shake-anim { animation: shake 0.3s ease-in-out; }
    
    .pixel-border {
      box-shadow: 
        inset -4px -4px 0px 0px #1a1a2e,
        inset 4px 4px 0px 0px #4a4a6a;
    }
    
    canvas { image-rendering: pixelated; }
  </style>
  <script src="/_sdk/element_sdk.js"></script>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-900">
  <div id="app" class="h-full w-full"></div>
  <script>
    // Game Configuration
    const defaultConfig = {
      game_title: 'Pixel Wanderer',
      background_color: '#0f0f23',
      surface_color: '#1a1a2e',
      text_color: '#e0e0ff',
      primary_action: '#ff6b6b',
      secondary_action: '#4ecdc4'
    };

    let config = { ...defaultConfig };

    // Game State
    const GameState = {
      MENU: 'menu',
      WORLD_MAP: 'worldMap',
      PLAYING: 'playing',
      LEVEL_COMPLETE: 'levelComplete',
      GAME_OVER: 'gameOver',
      VICTORY: 'victory'
    };

    let gameState = GameState.MENU;
    let currentLevel = 1;
    let unlockedLevels = [1];
    let completedLevels = [];

    // Player State
    let player = {
      x: 100,
      y: 300,
      vx: 0,
      vy: 0,
      width: 32,
      height: 40,
      hp: 5,
      maxHp: 5,
      powerUp: null,
      onGround: false,
      facing: 1,
      attacking: false,
      attackCooldown: 0,
      invincible: 0,
      jumpCount: 0,
      maxJumps: 1
    };

    // Power-up Types
    const PowerUpTypes = {
      FIREBALL: { name: 'Inferno', color: '#ff4500', temporary: false, attack: 'fireball', description: 'Fireballs' },
      ICE: { name: 'Frost', color: '#00bfff', temporary: false, attack: 'ice', description: 'Ice shards' },
      BUBBLE: { name: 'Bubble', color: '#a0d8ff', temporary: false, attack: 'bubble', description: 'Bubbles' },
      WIND: { name: 'Tempest', color: '#87ceeb', temporary: false, attack: 'wind', description: 'Wind blast' },
      EARTH: { name: 'Tremor', color: '#8b7355', temporary: false, attack: 'earth', description: 'Earth spikes' },
      LIGHTNING: { name: 'Thunder', color: '#ffd700', temporary: false, attack: 'lightning', description: 'Lightning bolts' }
    };

    // Enemy Types
    const EnemyTypes = {
      SLIME: { width: 28, height: 24, color: '#50c878', speed: 1, hp: 1, damage: 1, flying: false, behavior: 'patrol' },
      BAT: { width: 32, height: 24, color: '#8b4513', speed: 2, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      KNIGHT: { width: 32, height: 44, color: '#708090', speed: 0.6, hp: 3, damage: 2, flying: false, behavior: 'guard' },
      VINE_SPIDER: { width: 36, height: 20, color: '#4a4a2a', speed: 1.2, hp: 2, damage: 1, flying: false, behavior: 'patrol' },
      POISON_WASP: { width: 28, height: 20, color: '#ffcc00', speed: 2.5, hp: 1, damage: 2, flying: true, behavior: 'swoop' },
      SAND_SCORPION: { width: 40, height: 28, color: '#cc8800', speed: 1.5, hp: 2, damage: 2, flying: false, behavior: 'patrol' },
      HERMIT_CRAB: { width: 36, height: 28, color: '#cc3333', speed: 0.8, hp: 2, damage: 1, flying: false, behavior: 'patrol' },
      JELLYFISH: { width: 32, height: 36, color: '#ff69b4', speed: 0.8, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      SHARK: { width: 48, height: 24, color: '#4a4a8a', speed: 2, hp: 3, damage: 2, flying: false, behavior: 'chase' },
      ICE_GOLEM: { width: 36, height: 48, color: '#87ceeb', speed: 0.5, hp: 3, damage: 1, flying: false, behavior: 'guard' },
      FIRE_ELEMENTAL: { width: 32, height: 32, color: '#ff4500', speed: 1.8, hp: 2, damage: 2, flying: true, behavior: 'swoop' },
      STONE_GIANT: { width: 44, height: 56, color: '#696969', speed: 0.4, hp: 5, damage: 3, flying: false, behavior: 'patrol' },
      SKY_SPRITE: { width: 24, height: 24, color: '#ffff00', speed: 2.2, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      LAVA_BLOB: { width: 36, height: 36, color: '#ff6600', speed: 0.6, hp: 3, damage: 2, flying: false, behavior: 'patrol' },
      SHADOW_KNIGHT: { width: 40, height: 48, color: '#1a1a3e', speed: 1.2, hp: 4, damage: 3, flying: false, behavior: 'chase' },
      FROG: { width: 28, height: 20, color: '#4a8a2a', speed: 0.8, hp: 1, damage: 1, flying: false, behavior: 'jump' },
      FISH: { width: 32, height: 16, color: '#ff6644', speed: 2, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      SQUIRREL: { width: 24, height: 24, color: '#8b4513', speed: 1.5, hp: 1, damage: 1, flying: false, behavior: 'patrol' },
      PLANT: { width: 28, height: 28, color: '#228b22', speed: 0.3, hp: 2, damage: 1, flying: false, behavior: 'guard' },
      ZOMBIE: { width: 32, height: 44, color: '#4a8a4a', speed: 0.6, hp: 2, damage: 2, flying: false, behavior: 'chase' },
      GHOST: { width: 32, height: 40, color: '#ffffff', speed: 1.2, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      NEON_MONSTER: { width: 36, height: 36, color: '#00ffff', speed: 1.8, hp: 2, damage: 2, flying: false, behavior: 'patrol' },
      STORM_ELEMENTAL: { width: 40, height: 40, color: '#6a5acd', speed: 1.5, hp: 3, damage: 2, flying: true, behavior: 'swoop' },
      LEPRECHAUN: { width: 24, height: 20, color: '#228b22', speed: 1.2, hp: 1, damage: 1, flying: false, behavior: 'jump' },
      STAR: { width: 28, height: 28, color: '#ffff99', speed: 1.5, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      ALIEN: { width: 32, height: 32, color: '#00ff00', speed: 1.8, hp: 1, damage: 1, flying: true, behavior: 'swoop' },
      MUSHROOM: { width: 28, height: 24, color: '#cc5500', speed: 0.3, hp: 1, damage: 1, flying: false, behavior: 'guard' }
    };

    // Game Objects
    let platforms = [];
    let enemies = [];
    let powerUps = [];
    let projectiles = [];
    let particles = [];
    let levelEnd = null;

    // Canvas and Context
    let canvas, ctx;
    let cameraX = 0;

    // Input
    const keys = {};

    // Level Definitions
    const levels = {
      1: { name: 'Jungle Vines', bgColor: '#1a3a1a', groundColor: '#2d5a2d', width: 2400, vertical: false, platforms: [{ x: 0, y: 450, w: 600, h: 50 }, { x: 700, y: 400, w: 200, h: 30 }, { x: 1000, y: 350, w: 150, h: 30 }, { x: 1200, y: 450, w: 400, h: 50 }, { x: 1700, y: 380, w: 200, h: 30 }, { x: 2000, y: 450, w: 400, h: 50 }], enemies: [{ type: 'VINE_SPIDER', x: 400, y: 420 }, { type: 'VINE_SPIDER', x: 800, y: 370 }, { type: 'POISON_WASP', x: 1100, y: 250 }, { type: 'VINE_SPIDER', x: 1400, y: 420 }], powerUp: 'FIREBALL', endX: 2300 },
      2: { name: 'Sandy Desert', bgColor: '#3a3a1a', groundColor: '#cc9944', width: 2800, vertical: false, platforms: [{ x: 0, y: 450, w: 400, h: 50 }, { x: 500, y: 380, w: 150, h: 30 }, { x: 750, y: 300, w: 150, h: 30 }, { x: 1000, y: 380, w: 200, h: 30 }, { x: 1300, y: 450, w: 300, h: 50 }, { x: 1700, y: 350, w: 200, h: 30 }, { x: 2000, y: 280, w: 150, h: 30 }, { x: 2250, y: 350, w: 200, h: 30 }, { x: 2500, y: 450, w: 300, h: 50 }], enemies: [{ type: 'SAND_SCORPION', x: 300, y: 400 }, { type: 'SAND_SCORPION', x: 600, y: 280 }, { type: 'SAND_SCORPION', x: 900, y: 200 }, { type: 'SAND_SCORPION', x: 1400, y: 400 }, { type: 'SAND_SCORPION', x: 1800, y: 250 }, { type: 'SAND_SCORPION', x: 2100, y: 230 }], powerUp: 'WIND', endX: 2700 },
      3: { name: 'Beach Paradise', bgColor: '#ccaa44', groundColor: '#ddbb55', width: 3200, vertical: false, platforms: [{ x: 0, y: 450, w: 350, h: 50 }, { x: 450, y: 400, w: 120, h: 30 }, { x: 650, y: 340, w: 120, h: 30 }, { x: 850, y: 280, w: 120, h: 30 }, { x: 1050, y: 350, w: 200, h: 30 }, { x: 1350, y: 450, w: 400, h: 50 }, { x: 1850, y: 380, w: 150, h: 30 }, { x: 2100, y: 300, w: 150, h: 30 }, { x: 2350, y: 380, w: 150, h: 30 }, { x: 2600, y: 450, w: 200, h: 50 }, { x: 2900, y: 450, w: 300, h: 50 }], enemies: [{ type: 'HERMIT_CRAB', x: 300, y: 350 }, { type: 'HERMIT_CRAB', x: 550, y: 360 }, { type: 'POISON_WASP', x: 750, y: 240 }, { type: 'POISON_WASP', x: 1000, y: 200 }, { type: 'HERMIT_CRAB', x: 1500, y: 400 }, { type: 'HERMIT_CRAB', x: 1950, y: 280 }, { type: 'POISON_WASP', x: 2200, y: 250 }, { type: 'HERMIT_CRAB', x: 2450, y: 280 }], powerUp: 'BUBBLE', endX: 3100 },
      4: { name: 'Coral Reef', bgColor: '#1864b1', groundColor: '#ddbb55', width: 3400, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3150, y: 450, w: 250, h: 50 }], enemies: [{ type: 'JELLYFISH', x: 250, y: 300 }, { type: 'HERMIT_CRAB', x: 500, y: 350 }, { type: 'JELLYFISH', x: 750, y: 250 }, { type: 'HERMIT_CRAB', x: 1000, y: 350 }, { type: 'JELLYFISH', x: 1300, y: 300 }, { type: 'HERMIT_CRAB', x: 1600, y: 320 }, { type: 'JELLYFISH', x: 1900, y: 250 }, { type: 'HERMIT_CRAB', x: 2100, y: 320 }, { type: 'JELLYFISH', x: 2400, y: 300 }, { type: 'HERMIT_CRAB', x: 2750, y: 330 }, { type: 'JELLYFISH', x: 3000, y: 250 }], powerUp: 'ICE', endX: 3300 },
      5: { name: 'Ocean Depths', bgColor: '#0a1a3a', groundColor: '#1a3a5a', width: 3600, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 450, w: 200, h: 50 }, { x: 950, y: 350, w: 150, h: 30 }, { x: 1200, y: 280, w: 150, h: 30 }, { x: 1450, y: 350, w: 150, h: 30 }, { x: 1700, y: 450, w: 300, h: 50 }, { x: 2100, y: 380, w: 150, h: 30 }, { x: 2350, y: 300, w: 200, h: 30 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 450, w: 200, h: 50 }, { x: 3200, y: 450, w: 400, h: 50 }], enemies: [{ type: 'JELLYFISH', x: 250, y: 300 }, { type: 'SHARK', x: 500, y: 380 }, { type: 'JELLYFISH', x: 750, y: 350 }, { type: 'SHARK', x: 1050, y: 250 }, { type: 'JELLYFISH', x: 1300, y: 200 }, { type: 'SHARK', x: 1550, y: 250 }, { type: 'JELLYFISH', x: 1850, y: 300 }, { type: 'SHARK', x: 2200, y: 330 }, { type: 'JELLYFISH', x: 2450, y: 200 }, { type: 'SHARK', x: 2750, y: 330 }, { type: 'JELLYFISH', x: 3000, y: 350 }], powerUp: 'LIGHTNING', endX: 3500 },
      6: { name: 'Glacier Peaks', bgColor: '#1a2a3a', groundColor: '#a0d8ff', width: 4000, vertical: false, platforms: [{ x: 0, y: 450, w: 250, h: 50 }, { x: 350, y: 380, w: 120, h: 30 }, { x: 550, y: 300, w: 120, h: 30 }, { x: 750, y: 380, w: 120, h: 30 }, { x: 950, y: 450, w: 200, h: 50 }, { x: 1250, y: 350, w: 150, h: 30 }, { x: 1500, y: 270, w: 150, h: 30 }, { x: 1750, y: 350, w: 150, h: 30 }, { x: 2000, y: 450, w: 250, h: 50 }, { x: 2350, y: 380, w: 120, h: 30 }, { x: 2550, y: 300, w: 120, h: 30 }, { x: 2750, y: 220, w: 120, h: 30 }, { x: 2950, y: 300, w: 120, h: 30 }, { x: 3150, y: 380, w: 150, h: 30 }, { x: 3400, y: 450, w: 200, h: 50 }, { x: 3700, y: 450, w: 300, h: 50 }], enemies: [{ type: 'ICE_GOLEM', x: 150, y: 400 }, { type: 'ICE_GOLEM', x: 550, y: 270 }, { type: 'ICE_GOLEM', x: 1050, y: 400 }, { type: 'ICE_GOLEM', x: 1600, y: 210 }, { type: 'ICE_GOLEM', x: 2100, y: 400 }, { type: 'ICE_GOLEM', x: 2750, y: 150 }, { type: 'ICE_GOLEM', x: 3250, y: 330 }, { type: 'ICE_GOLEM', x: 3800, y: 350 }], powerUp: 'EARTH', endX: 3900 },
      7: { name: 'Cave', bgColor: '#1a1a3a', groundColor: '#3a3a5a', width: 3000, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2850, y: 450, w: 150, h: 50 }], enemies: [{ type: 'BAT', x: 300, y: 250 }, { type: 'VINE_SPIDER', x: 550, y: 270 }, { type: 'BAT', x: 850, y: 280 }, { type: 'VINE_SPIDER', x: 1100, y: 400 }, { type: 'BAT', x: 1550, y: 200 }, { type: 'VINE_SPIDER', x: 1850, y: 230 }, { type: 'BAT', x: 2100, y: 250 }, { type: 'VINE_SPIDER', x: 2400, y: 400 }], powerUp: 'ICE', endX: 2900 },
      8: { name: 'Mountain Ruins', bgColor: '#0a0a0a', groundColor: '#696969', width: 3200, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3100, y: 450, w: 100, h: 50 }], enemies: [{ type: 'STONE_GIANT', x: 250, y: 350 }, { type: 'POISON_WASP', x: 550, y: 250 }, { type: 'STONE_GIANT', x: 850, y: 250 }, { type: 'POISON_WASP', x: 1050, y: 350 }, { type: 'STONE_GIANT', x: 1400, y: 300 }, { type: 'POISON_WASP', x: 1700, y: 200 }, { type: 'STONE_GIANT', x: 2000, y: 300 }, { type: 'POISON_WASP', x: 2350, y: 350 }, { type: 'STONE_GIANT', x: 2700, y: 300 }], powerUp: 'FIREBALL', endX: 3100 },
      9: { name: 'Mountain Climb', bgColor: '#87b5eb', groundColor: '#696969', width: 4400, vertical: false, platforms: [{ x: 0, y: 450, w: 250, h: 50 }, { x: 350, y: 380, w: 120, h: 30 }, { x: 550, y: 300, w: 120, h: 30 }, { x: 750, y: 380, w: 120, h: 30 }, { x: 950, y: 450, w: 200, h: 50 }, { x: 1250, y: 350, w: 150, h: 30 }, { x: 1500, y: 270, w: 150, h: 30 }, { x: 1750, y: 350, w: 150, h: 30 }, { x: 2000, y: 450, w: 250, h: 50 }, { x: 2350, y: 380, w: 120, h: 30 }, { x: 2550, y: 300, w: 120, h: 30 }, { x: 2750, y: 220, w: 120, h: 30 }, { x: 2950, y: 300, w: 120, h: 30 }, { x: 3150, y: 380, w: 150, h: 30 }, { x: 3400, y: 450, w: 200, h: 50 }, { x: 3700, y: 380, w: 150, h: 30 }, { x: 4000, y: 300, w: 200, h: 30 }, { x: 4200, y: 450, w: 200, h: 50 }], enemies: [{ type: 'STONE_GIANT', x: 150, y: 350 }, { type: 'STONE_GIANT', x: 450, y: 250 }, { type: 'STONE_GIANT', x: 650, y: 200 }, { type: 'STONE_GIANT', x: 850, y: 250 }, { type: 'STONE_GIANT', x: 1050, y: 350 }, { type: 'STONE_GIANT', x: 1350, y: 250 }, { type: 'STONE_GIANT', x: 1600, y: 180 }, { type: 'STONE_GIANT', x: 1850, y: 250 }, { type: 'STONE_GIANT', x: 2100, y: 350 }, { type: 'STONE_GIANT', x: 2450, y: 280 }, { type: 'STONE_GIANT', x: 2650, y: 200 }, { type: 'STONE_GIANT', x: 2850, y: 100 }, { type: 'STONE_GIANT', x: 3050, y: 200 }, { type: 'STONE_GIANT', x: 3250, y: 280 }, { type: 'STONE_GIANT', x: 3500, y: 350 }, { type: 'STONE_GIANT', x: 3800, y: 280 }, { type: 'STONE_GIANT', x: 4050, y: 200 }], powerUp: 'WIND', endX: 4300 },
      10: { name: 'Lava Cavern', bgColor: '#1a0a0a', groundColor: '#8b0000', width: 3200, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 450, w: 200, h: 50 }, { x: 950, y: 350, w: 150, h: 30 }, { x: 1200, y: 280, w: 150, h: 30 }, { x: 1450, y: 350, w: 150, h: 30 }, { x: 1700, y: 450, w: 300, h: 50 }, { x: 2100, y: 380, w: 150, h: 30 }, { x: 2350, y: 300, w: 200, h: 30 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 450, w: 200, h: 50 }, { x: 3100, y: 450, w: 100, h: 50 }], enemies: [{ type: 'FIRE_ELEMENTAL', x: 250, y: 300 }, { type: 'LAVA_BLOB', x: 500, y: 380 }, { type: 'FIRE_ELEMENTAL', x: 750, y: 350 }, { type: 'LAVA_BLOB', x: 1050, y: 280 }, { type: 'FIRE_ELEMENTAL', x: 1300, y: 200 }, { type: 'LAVA_BLOB', x: 1550, y: 280 }, { type: 'FIRE_ELEMENTAL', x: 1850, y: 300 }, { type: 'LAVA_BLOB', x: 2200, y: 330 }, { type: 'FIRE_ELEMENTAL', x: 2450, y: 200 }, { type: 'LAVA_BLOB', x: 2750, y: 330 }], powerUp: 'BUBBLE', endX: 3100 },
      11: { name: 'Cloud Kingdom', bgColor: '#3a5a7a', groundColor: '#ffffff', width: 2400, vertical: false, platforms: [{ x: 0, y: 450, w: 600, h: 50 }, { x: 700, y: 400, w: 200, h: 30 }, { x: 1000, y: 350, w: 150, h: 30 }, { x: 1200, y: 450, w: 400, h: 50 }, { x: 1700, y: 380, w: 200, h: 30 }, { x: 2000, y: 450, w: 400, h: 50 }], enemies: [{ type: 'SKY_SPRITE', x: 400, y: 300 }, { type: 'LEPRECHAUN', x: 800, y: 370 }, { type: 'SKY_SPRITE', x: 1100, y: 250 }, { type: 'LEPRECHAUN', x: 1400, y: 420 }, { type: 'SKY_SPRITE', x: 1800, y: 280 }, { type: 'LEPRECHAUN', x: 2100, y: 380 }], powerUp: 'ICE', endX: 2300 },
      12: { name: 'Space', bgColor: '#000010', groundColor: '#1a1a3a', width: 3400, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3150, y: 450, w: 250, h: 50 }], enemies: [{ type: 'STAR', x: 250, y: 300 }, { type: 'ALIEN', x: 500, y: 350 }, { type: 'STAR', x: 750, y: 250 }, { type: 'ALIEN', x: 1000, y: 350 }, { type: 'STAR', x: 1300, y: 300 }, { type: 'ALIEN', x: 1600, y: 320 }, { type: 'STAR', x: 1900, y: 250 }, { type: 'ALIEN', x: 2100, y: 320 }, { type: 'STAR', x: 2400, y: 300 }, { type: 'ALIEN', x: 2750, y: 330 }, { type: 'STAR', x: 3000, y: 250 }], powerUp: 'FIREBALL', endX: 3300 },
      13: { name: 'Storm', bgColor: '#2a2a3a', groundColor: '#3a3a4a', width: 2800, vertical: false, platforms: [{ x: 0, y: 450, w: 350, h: 50 }, { x: 450, y: 400, w: 120, h: 30 }, { x: 650, y: 340, w: 120, h: 30 }, { x: 850, y: 280, w: 120, h: 30 }, { x: 1050, y: 350, w: 200, h: 30 }, { x: 1350, y: 450, w: 400, h: 50 }, { x: 1850, y: 380, w: 150, h: 30 }, { x: 2100, y: 300, w: 150, h: 30 }, { x: 2350, y: 380, w: 150, h: 30 }, { x: 2600, y: 450, w: 200, h: 50 }], enemies: [{ type: 'STORM_ELEMENTAL', x: 300, y: 300 }, { type: 'STORM_ELEMENTAL', x: 600, y: 250 }, { type: 'STORM_ELEMENTAL', x: 900, y: 200 }, { type: 'STORM_ELEMENTAL', x: 1200, y: 280 }, { type: 'STORM_ELEMENTAL', x: 1500, y: 350 }, { type: 'STORM_ELEMENTAL', x: 1900, y: 300 }, { type: 'STORM_ELEMENTAL', x: 2200, y: 200 }, { type: 'STORM_ELEMENTAL', x: 2500, y: 300 }], powerUp: 'LIGHTNING', endX: 2700 },
      14: { name: 'Swamp', bgColor: '#2a3a2a', groundColor: '#3a4a3a', width: 3000, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2850, y: 450, w: 150, h: 50 }], enemies: [{ type: 'VINE_SPIDER', x: 300, y: 350 }, { type: 'FROG', x: 550, y: 450 }, { type: 'VINE_SPIDER', x: 800, y: 270 }, { type: 'FROG', x: 1050, y: 450 }, { type: 'VINE_SPIDER', x: 1350, y: 400 }, { type: 'FROG', x: 1600, y: 450 }, { type: 'VINE_SPIDER', x: 1900, y: 300 }, { type: 'FROG', x: 2150, y: 450 }, { type: 'VINE_SPIDER', x: 2450, y: 330 }, { type: 'FROG', x: 2750, y: 450 }], powerUp: 'BUBBLE', endX: 2900 },
      15: { name: 'Graveyard', bgColor: '#1a1a2a', groundColor: '#3a3a4a', width: 3200, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3100, y: 450, w: 100, h: 50 }], enemies: [{ type: 'ZOMBIE', x: 250, y: 400 }, { type: 'GHOST', x: 500, y: 300 }, { type: 'ZOMBIE', x: 750, y: 270 }, { type: 'GHOST', x: 1000, y: 250 }, { type: 'ZOMBIE', x: 1350, y: 350 }, { type: 'GHOST', x: 1600, y: 200 }, { type: 'ZOMBIE', x: 1900, y: 300 }, { type: 'GHOST', x: 2200, y: 280 }, { type: 'ZOMBIE', x: 2500, y: 330 }, { type: 'GHOST', x: 2750, y: 250 }], powerUp: 'EARTH', endX: 3100 },
      16: { name: 'Haunted Mansion', bgColor: '#0a0a1a', groundColor: '#1a0a2a', width: 3400, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3150, y: 450, w: 250, h: 50 }], enemies: [{ type: 'VINE_SPIDER', x: 250, y: 350 }, { type: 'GHOST', x: 500, y: 300 }, { type: 'VINE_SPIDER', x: 750, y: 270 }, { type: 'GHOST', x: 1000, y: 250 }, { type: 'VINE_SPIDER', x: 1350, y: 350 }, { type: 'GHOST', x: 1600, y: 200 }, { type: 'VINE_SPIDER', x: 1900, y: 300 }, { type: 'GHOST', x: 2200, y: 280 }, { type: 'VINE_SPIDER', x: 2500, y: 330 }, { type: 'GHOST', x: 2750, y: 250 }, { type: 'VINE_SPIDER', x: 3000, y: 300 }], powerUp: 'ICE', endX: 3300 },
      17: { name: 'Autumnal Forest', bgColor: '#4a2a0a', groundColor: '#5a3a1a', width: 3200, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3100, y: 450, w: 100, h: 50 }], enemies: [{ type: 'MUSHROOM', x: 300, y: 400 }, { type: 'POISON_WASP', x: 550, y: 270 }, { type: 'MUSHROOM', x: 800, y: 300 }, { type: 'POISON_WASP', x: 1050, y: 250 }, { type: 'MUSHROOM', x: 1350, y: 380 }, { type: 'POISON_WASP', x: 1600, y: 220 }, { type: 'MUSHROOM', x: 1900, y: 320 }, { type: 'POISON_WASP', x: 2200, y: 270 }, { type: 'MUSHROOM', x: 2500, y: 330 }, { type: 'POISON_WASP', x: 2750, y: 250 }], powerUp: 'WIND', endX: 3100 },
      18: { name: 'River', bgColor: '#3a5a2a', groundColor: '#5a6a3a', width: 3400, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3150, y: 450, w: 250, h: 50 }], enemies: [{ type: 'FISH', x: 250, y: 350 }, { type: 'FROG', x: 500, y: 450 }, { type: 'FISH', x: 750, y: 270 }, { type: 'FROG', x: 1000, y: 450 }, { type: 'FISH', x: 1350, y: 300 }, { type: 'FROG', x: 1600, y: 450 }, { type: 'FISH', x: 1900, y: 250 }, { type: 'FROG', x: 2200, y: 450 }, { type: 'FISH', x: 2500, y: 300 }, { type: 'FROG', x: 2750, y: 450 }, { type: 'FISH', x: 3000, y: 280 }], powerUp: 'BUBBLE', endX: 3300 },
      19: { name: 'Garden', bgColor: '#5a7a6a', groundColor: '#6a8a7a', width: 3200, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3100, y: 450, w: 100, h: 50 }], enemies: [{ type: 'MUSHROOM', x: 300, y: 400 }, { type: 'POISON_WASP', x: 550, y: 270 }, { type: 'LEPRECHAUN', x: 800, y: 370 }, { type: 'POISON_WASP', x: 1050, y: 250 }, { type: 'MUSHROOM', x: 1350, y: 380 }, { type: 'POISON_WASP', x: 1600, y: 220 }, { type: 'LEPRECHAUN', x: 1900, y: 370 }, { type: 'POISON_WASP', x: 2200, y: 270 }, { type: 'MUSHROOM', x: 2500, y: 330 }], powerUp: 'EARTH', endX: 3100 },
      20: { name: 'Neon City', bgColor: '#0a0a1a', groundColor: '#1a1a3a', width: 3600, vertical: false, platforms: [{ x: 0, y: 450, w: 300, h: 50 }, { x: 400, y: 380, w: 150, h: 30 }, { x: 650, y: 300, w: 150, h: 30 }, { x: 900, y: 380, w: 150, h: 30 }, { x: 1150, y: 450, w: 250, h: 50 }, { x: 1500, y: 350, w: 150, h: 30 }, { x: 1750, y: 270, w: 150, h: 30 }, { x: 2000, y: 350, w: 150, h: 30 }, { x: 2250, y: 450, w: 300, h: 50 }, { x: 2650, y: 380, w: 150, h: 30 }, { x: 2900, y: 300, w: 150, h: 30 }, { x: 3150, y: 380, w: 150, h: 30 }, { x: 3400, y: 450, w: 200, h: 50 }], enemies: [{ type: 'NEON_MONSTER', x: 250, y: 350 }, { type: 'NEON_MONSTER', x: 550, y: 270 }, { type: 'NEON_MONSTER', x: 850, y: 300 }, { type: 'NEON_MONSTER', x: 1100, y: 350 }, { type: 'NEON_MONSTER', x: 1400, y: 300 }, { type: 'NEON_MONSTER', x: 1700, y: 220 }, { type: 'NEON_MONSTER', x: 2000, y: 300 }, { type: 'NEON_MONSTER', x: 2350, y: 330 }, { type: 'NEON_MONSTER', x: 2700, y: 250 }, { type: 'NEON_MONSTER', x: 3000, y: 300 }], powerUp: 'LIGHTNING', endX: 3500 },
      21: { name: 'Shadow Citadel', bgColor: '#0a0a1a', groundColor: '#2a2a4a', width: 4400, vertical: false, platforms: [{ x: 0, y: 450, w: 250, h: 50 }, { x: 350, y: 380, w: 120, h: 30 }, { x: 550, y: 300, w: 120, h: 30 }, { x: 750, y: 380, w: 120, h: 30 }, { x: 950, y: 450, w: 200, h: 50 }, { x: 1250, y: 350, w: 150, h: 30 }, { x: 1500, y: 270, w: 150, h: 30 }, { x: 1750, y: 350, w: 150, h: 30 }, { x: 2000, y: 450, w: 250, h: 50 }, { x: 2350, y: 380, w: 120, h: 30 }, { x: 2550, y: 300, w: 120, h: 30 }, { x: 2750, y: 220, w: 120, h: 30 }, { x: 2950, y: 300, w: 120, h: 30 }, { x: 3150, y: 380, w: 150, h: 30 }, { x: 3400, y: 450, w: 200, h: 50 }, { x: 3700, y: 380, w: 150, h: 30 }, { x: 4000, y: 300, w: 200, h: 30 }, { x: 4200, y: 450, w: 200, h: 50 }], enemies: [{ type: 'SHADOW_KNIGHT', x: 500, y: 350 }, { type: 'SHADOW_KNIGHT', x: 1050, y: 250 }, { type: 'SHADOW_KNIGHT', x: 1600, y: 180 }, { type: 'SHADOW_KNIGHT', x: 2100, y: 350 }, { type: 'SHADOW_KNIGHT', x: 2750, y: 150 }, { type: 'SHADOW_KNIGHT', x: 3250, y: 330 }, { type: 'SHADOW_KNIGHT', x: 3800, y: 280 }], powerUp: 'FIREBALL', endX: 4300 }
    };

    // Render Functions
    function render() {
      const app = document.getElementById('app');
      
      switch(gameState) {
        case GameState.MENU:
          renderMenu(app);
          break;
        case GameState.WORLD_MAP:
          renderWorldMap(app);
          break;
        case GameState.PLAYING:
        case GameState.LEVEL_COMPLETE:
        case GameState.GAME_OVER:
        case GameState.VICTORY:
          renderGame(app);
          break;
      }
    }

    function renderMenu(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center game-font" style="background: linear-gradient(180deg, ${config.background_color} 0%, ${config.surface_color} 100%);">
          <div class="text-center mb-12">
            <h1 id="game-title" class="text-3xl mb-4 float-anim" style="color: ${config.primary_action};">${config.game_title}</h1>
            <p class="text-xs" style="color: ${config.text_color};">An Epic Platformer Adventure</p>
          </div>
          
          <div class="space-y-4">
            <button id="start-btn" class="block w-48 py-3 px-6 text-xs pixel-border transition-all hover:scale-105" 
              style="background: ${config.primary_action}; color: ${config.surface_color};">
              START GAME
            </button>
            <button id="continue-btn" class="block w-48 py-3 px-6 text-xs pixel-border transition-all hover:scale-105 ${completedLevels.length === 0 ? 'opacity-50' : ''}" 
              style="background: ${config.secondary_action}; color: ${config.surface_color};" ${completedLevels.length === 0 ? 'disabled' : ''}>
              CONTINUE
            </button>
          </div>
          
          <div class="mt-12 text-center" style="color: ${config.text_color};">
            <p class="text-xs mb-2">CONTROLS</p>
            <p class="text-xs opacity-70">‚Üê ‚Üí Move | ‚Üë Jump | X Attack</p>
          </div>
        </div>
      `;
      
      document.getElementById('start-btn').onclick = () => {
        resetGame();
        gameState = GameState.WORLD_MAP;
        render();
      };
      
      document.getElementById('continue-btn').onclick = () => {
        if (completedLevels.length > 0) {
          gameState = GameState.WORLD_MAP;
          render();
        }
      };
    }

    function renderWorldMap(container) {
      const levelPositions = [
        { x: 10, y: 10 }, { x: 30, y: 10 }, { x: 50, y: 10 }, { x: 70, y: 10 }, { x: 90, y: 10 },
        { x: 90, y: 30 }, { x: 70, y: 30 }, { x: 50, y: 30 }, { x: 30, y: 30 }, { x: 10, y: 30 },
        { x: 10, y: 50 }, { x: 30, y: 50 }, { x: 50, y: 50 }, { x: 70, y: 50 }, { x: 90, y: 50 },
        { x: 90, y: 70 }, { x: 70, y: 70 }, { x: 50, y: 70 }, { x: 30, y: 70 }, { x: 10, y: 70 },
        { x: 50, y: 85 }
      ];
      
      let levelNodes = '';
      for (let i = 1; i <= 21; i++) {
        const pos = levelPositions[i-1] || { x: 50, y: 50 };
        const levelKey = i;
        const level = levels[levelKey];
        const unlocked = unlockedLevels.includes(levelKey);
        const completed = completedLevels.includes(levelKey);
        
        levelNodes += `
          <div class="absolute cursor-pointer transition-transform ${unlocked ? 'hover:scale-110' : 'opacity-40'}" 
            style="left: ${pos.x}%; top: ${pos.y}%; transform: translate(-50%, -50%);"
            data-level="${levelKey}" ${unlocked ? '' : 'disabled'}>
            <div class="w-20 h-20 rounded-full flex flex-col items-center justify-center pixel-border ${completed ? 'pulse-anim' : ''}"
              style="background: ${unlocked ? (completed ? config.secondary_action : config.primary_action) : '#444'};">
              <span class="text-sm game-font" style="color: ${config.surface_color};">${i}</span>
            </div>
            <p class="text-xs text-center mt-2 game-font whitespace-nowrap" style="color: ${config.text_color}; font-size: 6px;">${level.name}</p>
            ${completed ? '<p class="text-xs text-center game-font" style="color: ' + config.secondary_action + '; font-size: 8px;">‚úì</p>' : ''}
          </div>
        `;
      }
      
      container.innerHTML = `
        <div class="h-full w-full flex flex-col game-font" style="background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%);">
          <div class="p-4 flex justify-between items-center" style="background: ${config.surface_color};">
            <button id="back-btn" class="px-4 py-2 text-xs pixel-border" style="background: ${config.secondary_action}; color: ${config.surface_color};">
              ‚Üê MENU
            </button>
            <h2 style="color: ${config.text_color};">WORLD MAP (21 LEVELS)</h2>
            <div style="width: 100px;"></div>
          </div>
          
          <div class="flex-1 relative overflow-hidden">
            ${levelNodes}
          </div>
          
          <div class="p-4 text-center" style="background: ${config.surface_color};">
            <p class="text-xs" style="color: ${config.text_color};">Select a level to play</p>
          </div>
        </div>
      `;
      
      document.getElementById('back-btn').onclick = () => {
        gameState = GameState.MENU;
        render();
      };
      
      document.querySelectorAll('[data-level]').forEach(el => {
        const levelNum = parseFloat(el.dataset.level);
        if (unlockedLevels.includes(levelNum)) {
          el.onclick = () => startLevel(levelNum);
        }
      });
    }

    function renderGame(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col" style="background: ${config.background_color};">
          <div id="hud" class="flex justify-between items-center p-3 game-font text-xs" style="background: ${config.surface_color};">
            <div style="color: ${config.text_color};">Level ${currentLevel}: ${levels[currentLevel].name}</div>
            <div class="flex items-center gap-6">
              <div class="w-32 h-6 pixel-border" style="background: #333; position: relative; overflow: hidden;">
                <div id="hp-bar" style="width: ${(player.hp / player.maxHp) * 100}%; height: 100%; background: linear-gradient(90deg, ${config.primary_action}, #ff0000); transition: width 0.1s ease;"></div>
              </div>
              <div id="power-display" class="px-2 py-1" style="background: #444; color: #888; font-size: 8px;">No Power</div>
            </div>
          </div>
          <div class="flex-1 relative">
            <canvas id="gameCanvas" class="w-full h-full"></canvas>
          </div>
        </div>
        
        ${gameState === GameState.LEVEL_COMPLETE ? `
          <div class="fixed inset-0 bg-black/80 flex items-center justify-center game-font">
            <div class="text-center p-8 pixel-border" style="background: ${config.surface_color};">
              <h2 class="text-xl mb-4" style="color: ${config.secondary_action};">LEVEL COMPLETE!</h2>
              <p class="text-xs mb-6" style="color: ${config.text_color};">Great job, adventurer!</p>
              <button id="continue-level-btn" class="px-6 py-3 text-xs pixel-border" style="background: ${config.primary_action}; color: ${config.surface_color};">
                CONTINUE
              </button>
            </div>
          </div>
        ` : ''}
        
        ${gameState === GameState.GAME_OVER ? `
          <div class="fixed inset-0 bg-black/80 flex items-center justify-center game-font">
            <div class="text-center p-8 pixel-border" style="background: ${config.surface_color};">
              <h2 class="text-xl mb-4" style="color: ${config.primary_action};">GAME OVER</h2>
              <p class="text-xs mb-6" style="color: ${config.text_color};">Don't give up!</p>
              <div class="space-y-3">
                <button id="retry-btn" class="block w-full px-6 py-3 text-xs pixel-border" style="background: ${config.primary_action}; color: ${config.surface_color};">
                  RETRY LEVEL
                </button>
                <button id="map-btn" class="block w-full px-6 py-3 text-xs pixel-border" style="background: ${config.secondary_action}; color: ${config.surface_color};">
                  WORLD MAP
                </button>
              </div>
            </div>
          </div>
        ` : ''}
        
        ${gameState === GameState.VICTORY ? `
          <div class="fixed inset-0 bg-black/80 flex items-center justify-center game-font">
            <div class="text-center p-8 pixel-border" style="background: ${config.surface_color};">
              <h2 class="text-2xl mb-4 float-anim" style="color: ${config.secondary_action};">üéâ VICTORY! üéâ</h2>
              <p class="text-xs mb-6" style="color: ${config.text_color};">You conquered all 21 levels!</p>
              <button id="victory-btn" class="px-6 py-3 text-xs pixel-border" style="background: ${config.primary_action}; color: ${config.surface_color};">
                PLAY AGAIN
              </button>
            </div>
          </div>
        ` : ''}
      `;
      
      if (gameState === GameState.PLAYING) {
        initCanvas();
      }
      
      if (gameState === GameState.LEVEL_COMPLETE) {
        document.getElementById('continue-level-btn').onclick = () => {
          if (currentLevel < 21) {
            gameState = GameState.WORLD_MAP;
          } else {
            gameState = GameState.VICTORY;
          }
          render();
        };
      }
      
      if (gameState === GameState.GAME_OVER) {
        document.getElementById('retry-btn').onclick = () => {
          player.hp = player.maxHp;
          player.powerUp = null;
          startLevel(currentLevel);
        };
        document.getElementById('map-btn').onclick = () => {
          player.hp = player.maxHp;
          player.powerUp = null;
          gameState = GameState.WORLD_MAP;
          render();
        };
      }
      
      if (gameState === GameState.VICTORY) {
        document.getElementById('victory-btn').onclick = () => {
          resetGame();
          gameState = GameState.MENU;
          render();
        };
      }
    }

    function resetGame() {
      player.hp = 5;
      player.maxHp = 5;
      player.powerUp = null;
      unlockedLevels = [1];
      completedLevels = [];
      currentLevel = 1;
    }

    function startLevel(levelNum) {
      currentLevel = levelNum;
      const level = levels[levelNum];
      
      player.x = 100;
      player.y = 300;
      player.vx = 0;
      player.vy = 0;
      player.onGround = false;
      player.facing = 1;
      player.attacking = false;
      player.attackCooldown = 0;
      player.invincible = 120;
      player.jumpCount = 0;
      
      platforms = level.platforms.map(p => ({ ...p }));
      enemies = level.enemies.map(e => ({
        ...EnemyTypes[e.type],
        type: e.type,
        x: e.x,
        y: e.y,
        startX: e.x,
        startY: e.y,
        hp: EnemyTypes[e.type].hp,
        maxHp: EnemyTypes[e.type].hp,
        direction: 1,
        timer: 0,
        state: 'idle'
      }));
      
      const puType = level.powerUp;
      const puPositions = [];
      platforms.forEach((plat, idx) => {
        if (idx % 3 === 1 && idx < platforms.length - 1) {
          puPositions.push({ x: plat.x + plat.w / 2 - 12, y: plat.y - 45 });
        }
      });
      powerUps = puPositions.length > 0 ? puPositions.map(pos => ({ ...PowerUpTypes[puType], type: puType, x: pos.x, y: pos.y, collected: false })) : [];
      if (powerUps.length === 0) {
        powerUps = [{ ...PowerUpTypes[puType], type: puType, x: platforms[2].x + 100, y: platforms[2].y - 50, collected: false }];
      }
      
      projectiles = [];
      particles = [];
      levelEnd = { x: level.endX, y: 350, width: 60, height: 100 };
      cameraX = 0;
      
      gameState = GameState.PLAYING;
      render();
    }

    function initCanvas() {
      canvas = document.getElementById('gameCanvas');
      if (!canvas) return;
      
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      ctx = canvas.getContext('2d');
      
      gameLoop();
    }

    let lastTime = 0;
    function gameLoop(timestamp = 0) {
      if (gameState !== GameState.PLAYING) return;
      
      const deltaTime = Math.min(timestamp - lastTime, 50) / 16.67;
      lastTime = timestamp;
      
      update(deltaTime);
      draw();
      
      requestAnimationFrame(gameLoop);
    }

    function update(dt) {
      const level = levels[currentLevel];
      const moveSpeed = 5;
      const jumpForce = -12;
      const gravity = 0.6;
      
      if (keys['ArrowLeft'] || keys['KeyA']) {
        player.vx = -moveSpeed;
        player.facing = -1;
      } else if (keys['ArrowRight'] || keys['KeyD']) {
        player.vx = moveSpeed;
        player.facing = 1;
      } else {
        player.vx *= 0.8;
      }
      
      if ((keys['ArrowUp'] || keys['KeyW'] || keys['Space']) && player.jumpCount < player.maxJumps) {
        player.vy = jumpForce;
        player.jumpCount++;
        player.onGround = false;
        keys['ArrowUp'] = false;
        keys['KeyW'] = false;
        keys['Space'] = false;
      }
      
      if (keys['KeyX'] && player.attackCooldown <= 0) {
        performAttack();
        player.attackCooldown = 30;
      }
      
      if (player.attackCooldown > 0) player.attackCooldown -= dt;
      if (player.invincible > 0) player.invincible -= dt;
      
      const hpBar = document.getElementById('hp-bar');
      const powerDisplay = document.getElementById('power-display');
      if (hpBar) hpBar.style.width = (player.hp / player.maxHp) * 100 + '%';
      if (powerDisplay) {
        if (player.powerUp) {
          powerDisplay.style.background = PowerUpTypes[player.powerUp].color;
          powerDisplay.style.color = '#000';
          powerDisplay.textContent = PowerUpTypes[player.powerUp].name;
        } else {
          powerDisplay.style.background = '#444';
          powerDisplay.style.color = '#888';
          powerDisplay.textContent = 'No Power';
        }
      }
      
      player.vy += gravity * dt;
      player.x += player.vx * dt;
      player.y += player.vy * dt;
      
      player.onGround = false;
      platforms.forEach(plat => {
        if (player.x + player.width > plat.x && player.x < plat.x + plat.w) {
          if (player.y + player.height > plat.y && player.y + player.height < plat.y + plat.h + 20 && player.vy > 0) {
            player.y = plat.y - player.height;
            player.vy = 0;
            player.onGround = true;
            player.jumpCount = 0;
          }
        }
      });
      
      if (player.x < 0) player.x = 0;
      if (player.x > level.width - player.width) player.x = level.width - player.width;
      
      if (player.y > 500) {
        player.hp = 0;
        gameState = GameState.GAME_OVER;
        render();
        return;
      }
      
      const targetCam = player.x - canvas.width / 3;
      cameraX += (targetCam - cameraX) * 0.1;
      cameraX = Math.max(0, Math.min(cameraX, level.width - canvas.width));
      
      updateEnemies(dt);
      updateProjectiles(dt);
      
      particles = particles.filter(p => {
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.life -= dt;
        return p.life > 0;
      });
      
      powerUps.forEach(pu => {
        if (!pu.collected && checkCollision(player, { x: pu.x, y: pu.y, width: 24, height: 24 })) {
          pu.collected = true;
          player.powerUp = pu.type;
          player.hp = Math.min(player.hp + 1, player.maxHp);
          spawnParticles(pu.x + 12, pu.y + 12, pu.color, 10);
        }
      });
      
      enemies.forEach(enemy => {
        if (enemy.hp > 0 && player.invincible <= 0 && checkCollision(player, enemy)) {
          takeDamage(enemy.damage);
        }
      });
      
      if (checkCollision(player, levelEnd)) {
        completeLevel();
      }
    }

    function updateEnemies(dt) {
      enemies.forEach(enemy => {
        if (enemy.hp <= 0) return;
        
        enemy.timer += dt;
        
        switch(enemy.behavior) {
          case 'patrol':
            enemy.x += enemy.speed * enemy.direction * dt;
            if (Math.abs(enemy.x - enemy.startX) > 80) {
              enemy.direction *= -1;
            }
            break;
            
          case 'chase':
            const dist = player.x - enemy.x;
            if (Math.abs(dist) < 300) {
              enemy.x += Math.sign(dist) * enemy.speed * dt;
              enemy.direction = Math.sign(dist);
            } else {
              enemy.x += enemy.speed * enemy.direction * dt;
              if (Math.abs(enemy.x - enemy.startX) > 60) enemy.direction *= -1;
            }
            break;
            
          case 'swoop':
            enemy.x += Math.sin(enemy.timer * 0.1) * 2 * dt;
            enemy.y = enemy.startY + Math.sin(enemy.timer * 0.15) * 30;
            break;
            
          case 'guard':
            if (Math.abs(player.x - enemy.x) < 150) {
              enemy.x += Math.sign(player.x - enemy.x) * enemy.speed * dt;
              enemy.direction = Math.sign(player.x - enemy.x);
            }
            break;
            
          case 'jump':
            enemy.x += enemy.speed * enemy.direction * dt;
            if (Math.abs(enemy.x - enemy.startX) > 20) {
              enemy.direction *= -1;
            }
            if (Math.random() < 0.02 * dt) {
              enemy.vy = -10;
            }
            if (!enemy.vy) enemy.vy = 0;
            enemy.vy = (enemy.vy || 0) + 0.4 * dt;
            enemy.y += (enemy.vy || 0) * dt;
            
            let jumpPlat = false;
            platforms.forEach(plat => {
              if (enemy.x + enemy.width > plat.x && enemy.x < plat.x + plat.w) {
                if (enemy.y + enemy.height >= plat.y && enemy.y + enemy.height <= plat.y + 20) {
                  enemy.y = plat.y - enemy.height;
                  enemy.vy = 0;
                  jumpPlat = true;
                }
              }
            });
            break;
        }
        
        if (!enemy.flying && enemy.behavior !== 'jump') {
          let onPlat = false;
          platforms.forEach(plat => {
            if (enemy.x + enemy.width > plat.x && enemy.x < plat.x + plat.w) {
              if (enemy.y + enemy.height >= plat.y && enemy.y + enemy.height <= plat.y + 20) {
                enemy.y = plat.y - enemy.height;
                onPlat = true;
              }
            }
          });
        }
      });
    }

    function updateProjectiles(dt) {
      projectiles = projectiles.filter(proj => {
        proj.x += proj.vx * dt;
        proj.y += proj.vy * dt;
        
        if (proj.type !== 'lightning' && proj.type !== 'wind') {
          const gravityScale = proj.gravityScale !== undefined ? proj.gravityScale : 1;
          proj.vy += 0.3 * gravityScale * dt;
        }
        
        proj.life -= dt;
        
        if (proj.type === 'fireball' && proj.growth) {
          proj.width = Math.min(proj.width + proj.growth * dt, 48);
          proj.height = Math.min(proj.height + proj.growth * dt, 36);
        }
        
        let hitEnemy = false;
        if (proj.friendly) {
          enemies.forEach(enemy => {
            if (enemy.hp > 0 && checkCollision(proj, enemy) && !proj.hasHit) {
              enemy.hp -= proj.damage;
              proj.hasHit = true;
              hitEnemy = true;
              spawnParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#fff', 5);
              if (enemy.hp <= 0) {
                spawnParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.color, 15);
              }
            }
          });
        }
        
        if (hitEnemy && proj.type !== 'wind') {
          return false;
        }
        
        return proj.life > 0 && proj.x > cameraX - 50 && proj.x < cameraX + canvas.width + 50;
      });
    }

    function performAttack() {
      player.attacking = true;
      setTimeout(() => player.attacking = false, 200);
      
      const attackRange = { x: player.x + (player.facing > 0 ? player.width : -40), y: player.y, width: 40, height: player.height };
      
      if (!player.powerUp) {
        enemies.forEach(enemy => {
          if (enemy.hp > 0 && checkCollision(attackRange, enemy)) {
            enemy.hp -= 1;
            spawnParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#fff', 5);
            if (enemy.hp <= 0) {
              spawnParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.color, 15);
            }
          }
        });
      } else {
        const pu = PowerUpTypes[player.powerUp];
        
        switch(pu.attack) {
          case 'fireball':
            projectiles.push({
              x: player.x + player.width/2,
              y: player.y + player.height/2,
              width: 12,
              height: 10,
              vx: player.facing * 8,
              vy: -1,
              damage: 2,
              life: 120,
              color: '#ff4500',
              growth: 20,
              friendly: true,
              type: 'fireball',
              hasHit: false
            });
            break;

          case 'ice':
            for (let i = -1; i <= 1; i++) {
              projectiles.push({
                x: player.x + player.width/2,
                y: player.y + player.height/2,
                width: 20,
                height: 20,
                vx: player.facing * 10,
                vy: i * 5,
                damage: 1,
                life: 60,
                color: '#00bfff',
                friendly: true,
                type: 'ice',
                hasHit: false
              });
            }
            spawnParticles(player.x + player.width/2, player.y + player.height/2, '#00bfff', 8);
            break;

          case 'bubble':
            for (let i = -2; i <= 2; i++) {
              projectiles.push({
                x: player.x + player.width/2,
                y: player.y + player.height/2,
                width: 10,
                height: 10,
                vx: (player.facing * 2.5) + (Math.random() - 0.5) * 1,
                vy: -1 - Math.random() * 2,
                damage: 1,
                life: 180,
                color: '#a0d8ff',
                friendly: true,
                type: 'bubble',
                gravityScale: 0.2,
                hasHit: false
              });
            }
            spawnParticles(player.x + player.width/2, player.y + player.height/2, '#a0d8ff', 10);
            break;

          case 'wind':
            const windRange = 200;
            const windHeight = 80;
            const hitEnemies = [];
            
            enemies.forEach(enemy => {
              const distX = enemy.x - player.x;
              const distY = enemy.y - player.y;
              
              if (Math.abs(distX) < windRange && Math.abs(distY) < windHeight && Math.sign(distX) === player.facing && !hitEnemies.includes(enemy)) {
                hitEnemies.push(enemy);
                enemy.hp -= 1;
                enemy.x += player.facing * 100;
                enemy.direction = player.facing;
                spawnParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#87ceeb', 15);
                if (enemy.hp <= 0) {
                  spawnParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.color, 15);
                }
              }
            });
            
            for (let i = 0; i < 20; i++) {
              spawnParticles(
                player.x + player.width/2 + player.facing * (Math.random() * windRange),
                player.y + player.height/2 + (Math.random() - 0.5) * windHeight,
                '#87ceeb',
                1
              );
            }
            break;
            
          case 'earth':
            for (let i = -1; i <= 1; i++) {
              projectiles.push({
                x: player.x + player.width/2 + i * 20,
                y: player.y + player.height/2,
                width: 32,
                height: 32,
                vx: i * 2,
                vy: -7,
                damage: 2,
                life: 180,
                color: '#8b7355',
                friendly: true,
                type: 'earth',
                hasHit: false
              });
            }
            spawnParticles(player.x + player.width/2, player.y + player.height/2, '#8b7355', 15);
            break;
            
          case 'lightning':
            for (let i = 0; i < 3; i++) {
              const angle = (player.facing > 0 ? 0 : Math.PI) + (Math.random() - 0.5) * 0.6;
              projectiles.push({
                x: player.x + player.width/2,
                y: player.y + player.height/2,
                width: 12,
                height: 12,
                vx: Math.cos(angle) * 15,
                vy: Math.sin(angle) * 15,
                damage: 2,
                life: 30,
                color: '#ffd700',
                friendly: true,
                type: 'lightning',
                hasHit: false
              });
            }
            spawnParticles(player.x + player.width/2, player.y + player.height/2, '#ffd700', 12);
            break;
        }
      }
    }

    function takeDamage(amount) {
      if (player.powerUp && PowerUpTypes[player.powerUp] && !PowerUpTypes[player.powerUp].temporary) {
        player.powerUp = null;
        player.invincible = 60;
        spawnParticles(player.x + player.width/2, player.y + player.height/2, '#ff0', 15);
      } else {
        player.hp -= amount;
        player.invincible = 60;
        spawnParticles(player.x + player.width/2, player.y + player.height/2, '#f00', 10);
        if (player.hp <= 0) {
          gameState = GameState.GAME_OVER;
          render();
        }
      }
    }

    function completeLevel() {
      if (!completedLevels.includes(currentLevel)) {
        completedLevels.push(currentLevel);
      }
      if (currentLevel < 21 && !unlockedLevels.includes(currentLevel + 1)) {
        unlockedLevels.push(currentLevel + 1);
      }
      gameState = GameState.LEVEL_COMPLETE;
      render();
    }

    function checkCollision(a, b) {
      return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
    }

    function spawnParticles(x, y, color, count) {
      for (let i = 0; i < count; i++) {
        particles.push({
          x, y,
          vx: (Math.random() - 0.5) * 8,
          vy: (Math.random() - 0.5) * 8,
          size: 3 + Math.random() * 4,
          color,
          life: 20 + Math.random() * 20
        });
      }
    }

    function drawBackground(levelNum) {
      ctx.save();
      
      if (levelNum === 1) {
        for (let i = 0; i < 25; i++) {
          const x = ((i * 180) - cameraX * 0.3) % (canvas.width + 180) - 90;
          const y = 50 + (i % 5) * 50;
          
          ctx.strokeStyle = '#228b22';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(x, y + 100);
          ctx.quadraticCurveTo(x - 30, y + 50, x - 20, y);
          ctx.stroke();
          
          ctx.strokeStyle = '#1a6b1a';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x + 20, y + 100);
          ctx.quadraticCurveTo(x + 40, y + 50, x + 30, y);
          ctx.stroke();
        }
        
        for (let i = 0; i < 15; i++) {
          const x = ((i * 300) - cameraX * 0.2) % (canvas.width + 300) - 150;
          ctx.fillStyle = '#ff69b480';
          ctx.beginPath();
          ctx.arc(x, 120 + (i % 3) * 40, 20, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 2) {
        ctx.fillStyle = '#ccaa4460';
        ctx.fillRect(0, 280, canvas.width, canvas.height / 2);
        
        for (let i = 0; i < 12; i++) {
          const x = ((i * 350) - cameraX * 0.1) % (canvas.width + 350) - 175;
          ctx.fillStyle = '#ffff9970';
          ctx.beginPath();
          ctx.arc(x, 100 + (i % 4) * 40, 45, 0, Math.PI * 2);
          ctx.fill();
        }
        
        for (let i = 0; i < 8; i++) {
          const x = ((i * 400) - cameraX * 0.15) % (canvas.width + 400) - 200;
          ctx.fillStyle = '#cc9944';
          ctx.beginPath();
          ctx.moveTo(x, 120);
          ctx.lineTo(x + 60, 280);
          ctx.lineTo(x - 60, 280);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#998833';
          ctx.beginPath();
          ctx.moveTo(x, 120);
          ctx.lineTo(x + 30, 200);
          ctx.lineTo(x, 200);
          ctx.closePath();
          ctx.fill();
        }
      } else if (levelNum === 3) {
        ctx.fillStyle = '#ffff9950';
        ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
        ctx.fillStyle = '#1a5a80';
        ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);
        
        for (let i = 0; i < 8; i++) {
          const x = ((i * 350) - cameraX * 0.2) % (canvas.width + 350) - 175;
          ctx.strokeStyle = '#8b6914';
          ctx.lineWidth = 8;
          ctx.beginPath();
          ctx.moveTo(x, canvas.height / 2);
          ctx.lineTo(x, 120);
          ctx.stroke();
          
          ctx.fillStyle = '#228b22';
          ctx.beginPath();
          ctx.ellipse(x, 100, 55, 70, 0, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = '#1a6b1a';
          ctx.beginPath();
          ctx.ellipse(x - 20, 130, 40, 50, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.ellipse(x + 20, 130, 40, 50, 0, 0, Math.PI * 2);
          ctx.fill();
        }
        for (let i = 0; i < 10; i++) {
          const x = ((i * 300) - cameraX * 0.15) % (canvas.width + 300) - 150;
          ctx.fillStyle = '#1a5a80';
          ctx.beginPath();
          ctx.arc(x, 350 + Math.sin(Date.now() * 0.005 + i) * 20, 80, Math.PI, 2 * Math.PI);
          ctx.fill();
        }
        
        ctx.fillStyle = '#ffffff40';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } 
      else if (levelNum === 4) {
        ctx.fillStyle = '#2a5a4a';
        ctx.fillStyle = '#dab445';
        ctx.fillRect(0, 375, canvas.width, canvas.height / 2);
        for (let i = 0; i < 15; i++) {
          const x = ((i * 180) - cameraX * 0.2) % (canvas.width + 180) - 90;
          ctx.fillStyle = '#2a5a4a';
          ctx.beginPath();
          ctx.moveTo(x, 400);
          ctx.lineTo(x + 30, 300);
          ctx.lineTo(x + 60, 400);
          ctx.closePath();
          ctx.fill();
        }
        for (let i = 0; i < 20; i++) {
          const x = ((i * 200) - cameraX * 0.2) % (canvas.width + 200) - 100;
          const colors = ['#ff4500', '#ffaa00', '#00aa00', '#0088ff', '#ff69b4'];
          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.arc(x, 150 + (i % 4) * 50, 25, 0, Math.PI * 2);
          ctx.fill();
        }
        for (let i = 0; i < 20; i++) {
          const x = ((i * 200) - cameraX * 0.2) % (canvas.width + 200) - 100;
          const colors = ['#ff4500', '#ffaa00', '#00aa00', '#0088ff', '#ff69b4'];
          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.arc(x, 150 + (i % 4) * 50, 25, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 5) {
        for (let i = 0; i < 12; i++) {
          const x = ((i * 350) - cameraX * 0.2) % (canvas.width + 350) - 175;
          ctx.fillStyle = '#1a3a5a80';
          ctx.beginPath();
          ctx.moveTo(x, canvas.height);
          ctx.lineTo(x + 120, 200);
          ctx.lineTo(x + 240, canvas.height);
          ctx.closePath();
          ctx.fill();
          
          ctx.fillStyle = '#2a5a8a';
          ctx.beginPath();
          ctx.moveTo(x + 120, 200);
          ctx.lineTo(x + 180, 280);
          ctx.lineTo(x + 240, canvas.height);
          ctx.closePath();
          ctx.fill();
        }
        
        for (let i = 0; i < 18; i++) {
          const x = ((i * 200) - cameraX * 0.2) % (canvas.width + 200) - 100;
          ctx.strokeStyle = '#4ecdc480';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(x, 100 + Math.sin(Date.now() * 0.003 + i) * 15, 45, 0, Math.PI * 2);
          ctx.stroke();
          ctx.fillStyle = '#4ecdc420';
          ctx.fill();
          ctx.fillStyle = '#00ff8850';
          ctx.beginPath();
          ctx.arc(x + 60, 140 + Math.sin(Date.now() * 0.003 + i) * 12, 35, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 6) {
        ctx.fillStyle = '#5a5a9a';
        for (let i = 0; i < 10; i++) {
          const x = ((i * 350) - cameraX * 0.1) % (canvas.width + 350) - 175;
          ctx.beginPath();
          ctx.moveTo(x, 200);
          ctx.lineTo(x + 100, 50);
          ctx.lineTo(x + 200, 200);
          ctx.fill();
          ctx.fillStyle = '#ffffff30';
          ctx.beginPath();
          ctx.moveTo(x + 100, 50);
          ctx.lineTo(x + 150, 120);
          ctx.lineTo(x + 200, 200);
          ctx.fill();
          ctx.fillStyle = '#5a5a9a';
        }
        ctx.fillStyle = '#0a3a5a80';
        ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);
        for (let i = 0; i < 10; i++) {
          const x = ((i * 300) - cameraX * 0.15) % (canvas.width + 300) - 150;
          ctx.fillStyle = '#1a4a6a';
          ctx.beginPath();
          ctx.arc(x, 350 + Math.sin(Date.now() * 0.005 + i) * 20, 80, Math.PI, 2 * Math.PI);
          ctx.fill();
        }
      } else if (levelNum === 7) {
        for (let i = 0; i < 10; i++) {
          const x = ((i * 250) - cameraX * 0.2) % (canvas.width + 250) - 125;
          ctx.fillStyle = '#ff69b4';
          ctx.beginPath();
          ctx.arc(x, 100 + (i % 3) * 50, 20, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#ff1493';
          ctx.beginPath();
          ctx.arc(x + 30, 140, 15, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 8) {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#2a1a0a';
        for (let i = 0; i < 20; i++) {
          const x = ((i * 200) - cameraX * 0.3) % (canvas.width + 200) - 100;
          ctx.fillRect(x, 200, 80, canvas.height);
        }
        
        for (let i = 0; i < 8; i++) {
          const x = ((i * 350) - cameraX * 0.15) % (canvas.width + 350) - 175;
          ctx.fillStyle = '#ddbb55';
          ctx.fillRect(x, 80, 160, 220);
          ctx.fillStyle = '#998833';
          ctx.fillRect(x + 12, 100, 136, 12);
          ctx.fillRect(x + 12, 150, 136, 12);
          ctx.fillRect(x + 12, 200, 136, 12);
          ctx.fillRect(x + 12, 250, 136, 12);
          
          if (Math.floor(Date.now() / 200) % 2 === 0) {
            ctx.fillStyle = '#ff6600';
          } else {
            ctx.fillStyle = '#dd4400';
          }
          ctx.beginPath();
          ctx.arc(x + 35, 50 + (i % 2) * 80, 8, 0, Math.PI * 2);
          ctx.fill();
        }
        
        for (let i = 0; i < 20; i++) {
          const x = ((i * 160) - cameraX * 0.2) % (canvas.width + 160) - 80;
          ctx.strokeStyle = '#228b2280';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, 50);
          ctx.quadraticCurveTo(x + 35, 100, x + 20, 180);
          ctx.stroke();
        }
      } else if (levelNum === 9) {
        for (let i = 0; i < 12; i++) {
          const x = ((i * 300) - cameraX * 0.1) % (canvas.width + 300) - 150;
          ctx.fillStyle = '#6b7a8a';
          ctx.beginPath();
          ctx.moveTo(x, canvas.height);
          ctx.lineTo(x + 80, 100 - i * 15);
          ctx.lineTo(x + 160, canvas.height);
          ctx.fill();
          
          ctx.fillStyle = '#ffffff20';
          ctx.beginPath();
          ctx.moveTo(x + 80, 100 - i * 15);
          ctx.lineTo(x + 120, 150 - i * 12);
          ctx.lineTo(x + 160, canvas.height);
          ctx.fill();
        }
      } else if (levelNum === 10) {
        for (let i = 0; i < 10; i++) {
          const x = ((i * 250) - cameraX * 0.2) % (canvas.width + 250) - 125;
          ctx.fillStyle = '#ff8500';
          ctx.beginPath();
          ctx.arc(x, 100 + (i % 3) * 50, 20, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#ff7000';
          ctx.beginPath();
          ctx.arc(x + 30, 140, 15, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 11) {
        const rainbowColors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];
        for (let i = 0; i < rainbowColors.length; i++) {
          const startX = -100 - cameraX * 0.3;
          const startY = 150;
          ctx.strokeStyle = rainbowColors[i];
          ctx.lineWidth = 12;
          ctx.beginPath();
          ctx.moveTo(startX, startY - i * 15);
          ctx.lineTo(canvas.width + 100 - cameraX * 0.3, canvas.height + 50 - i * 15);
          ctx.stroke();
        }
        
        const cloudPositions = [
          { x: -150 - cameraX * 0.2, y: 80 },
          { x: canvas.width + 100 - cameraX * 0.2, y: 120 }
        ];
        
        cloudPositions.forEach(pos => {
          ctx.fillStyle = '#ffffff80';
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, 40, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(pos.x + 40, pos.y + 10, 50, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(pos.x + 80, pos.y, 40, 0, Math.PI * 2);
          ctx.fill();
        });
        
        for (let i = 0; i < 12; i++) {
          const x = ((i * 300) - cameraX * 0.25) % (canvas.width + 300) - 150;
          const colors = ['#ffb3ff', '#ffccff', '#ff99ff', '#ff99cc'];
          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.arc(x, 300 + (i % 3) * 50, 50, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 12) {
        for (let i = 0; i < 30; i++) {
          const seedX = (i * 73) % 1200;
          const seedY = ((i * 123) % 350) + 50;
          ctx.fillStyle = seedY % 3 === 0 ? '#ffff9970' : '#ffffff50';
          ctx.beginPath();
          ctx.arc(seedX - cameraX * 0, seedY, 2.5, 0, Math.PI * 2);
          ctx.fill();
        }
        
        const planets = [
          { x: 200, y: 100, r: 45, c: '#ff0000' },
          { x: 600, y: 150, r: 50, c: '#00ff00' },
          { x: 1000, y: 80, r: 35, c: '#0000ff' },
          { x: 1400, y: 140, r: 55, c: '#ffff00' },
          { x: 1800, y: 110, r: 40, c: '#ff00ff' },
          { x: 2200, y: 130, r: 48, c: '#00ffff' },
          { x: 2600, y: 100, r: 42, c: '#ffaa00' },
          { x: 3000, y: 120, r: 52, c: '#ff0080' }
        ];
        planets.forEach(p => {
          ctx.fillStyle = p.c;
          ctx.beginPath();
          ctx.arc(p.x - cameraX * 0.1, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = p.c + '30';
          ctx.beginPath();
          ctx.arc(p.x - cameraX * 0.1, p.y, p.r + 10, 0, Math.PI * 2);
          ctx.fill();
        });
      } else if (levelNum === 13) {
        for (let i = 0; i < 20; i++) {
          if (Math.sin(Date.now() * 0.004 + i) > 0.2) {
            ctx.strokeStyle = '#ffff6680';
            ctx.lineWidth = 4;
            const startX = ((i * 220) - cameraX * 0.2) % (canvas.width + 220) - 110;
            const startY = 40 + (i % 5) * 40;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(startX + (Math.random() - 0.5) * 80, startY + 150);
            ctx.stroke();
          }
        }
        
        for (let i = 0; i < 50; i++) {
          ctx.fillStyle = '#00ffff';
          const x = Math.random() * canvas.width;
          const y = Math.random() * 300;
          ctx.fillRect(x, y, 2, 10);
        }
        
      } else if (levelNum === 14) {
        ctx.fillStyle = '#1a2a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#3a2a0a80';
        ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);
        
        for (let i = 0; i < 50; i++) {
          ctx.fillStyle = '#00ffff';
          const x = Math.random() * canvas.width;
          const y = Math.random() * 300;
          ctx.fillRect(x, y, 2, 10);
        }
        
      } else if (levelNum === 15) {
        ctx.fillStyle = '#ffffff90';
        ctx.beginPath();
        ctx.arc(canvas.width * 0.75, 100, 70, 0, Math.PI * 2);
        ctx.fill();
        
        for (let i = 0; i < 12; i++) {
          const x = ((i * 280) - cameraX * 0.2) % (canvas.width + 280) - 140;
          ctx.fillStyle = '#505050';
          ctx.fillRect(x, 320, 70, 120);
          ctx.fillStyle = '#808080';
          ctx.fillRect(x + 10, 340, 18, 35);
          ctx.fillRect(x + 42, 340, 18, 35);
          ctx.fillStyle = '#ffffff50';
          ctx.fillRect(x + 12, 295, 46, 20);
        }
      } else if (levelNum === 16) {
        ctx.fillStyle = '#0a0a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < 22; i++) {
          const x = ((i * 180) - cameraX * 0.2) % (canvas.width + 180) - 90;
          ctx.strokeStyle = '#aa00aa50';
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ctx.moveTo(x, 30);
          ctx.lineTo(x + 90, 220);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x + 90, 30);
          ctx.lineTo(x, 220);
          ctx.stroke();
        }
        for (let i = 0; i < 10; i++) {
          const windowX = ((i * 280) - cameraX * 0.15) % (canvas.width + 280) - 140;
          ctx.fillStyle = '#ffff0050';
          ctx.fillRect(windowX, 80 + (i % 2) * 70, 35, 30);
          ctx.fillRect(windowX + 55, 80 + (i % 2) * 70, 35, 30);
        }
      } else if (levelNum === 17) {
        for (let i = 0; i < 50; i++) {
          const x = ((i * 90) - cameraX * 0.2) % (canvas.width + 90) - 45;
          const colors = ['#ff4500', '#ffaa00', '#ff6600', '#ff8800', '#ff3300'];
          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.arc(x, 60 + (i % 5) * 20, 14, 0, Math.PI * 2);
          ctx.fill();
        }
        for (let i = 0; i < 12; i++) {
          const x = ((i * 280) - cameraX * 0.15) % (canvas.width + 280) - 140;
          ctx.fillStyle = '#8b6914';
          ctx.fillRect(x, 120, 30, 180);
          ctx.fillStyle = '#ff6600';
          ctx.beginPath();
          ctx.ellipse(x + 15, 80, 45, 60, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#ff4500';
          ctx.beginPath();
          ctx.ellipse(x - 5, 110, 35, 45, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.ellipse(x + 35, 110, 35, 45, 0, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 18) {
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#6a8a4a');
        gradient.addColorStop(0.4, '#5a7a4a');
        gradient.addColorStop(1, '#1a5a8a');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < 12; i++) {
          const x = ((i * 300) - cameraX * 0.15) % (canvas.width + 300) - 150;
          ctx.fillStyle = '#8b6914';
          ctx.fillRect(x, 120, 45, 280);
          ctx.fillStyle = '#228b22';
          ctx.beginPath();
          ctx.ellipse(x + 22.5, 60, 60, 75, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#1a6b1a';
          ctx.beginPath();
          ctx.ellipse(x + 22.5, 110, 40, 55, 0, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 19) {
        for (let i = 0; i < 40; i++) {
          const x = ((i * 110) - cameraX * 0.2) % (canvas.width + 110) - 55;
          const colors = ['#ffb3d9', '#ffc4e6', '#ffd9f0', '#ffffcc', '#ccffff', '#ffccff', '#ffe6cc'];
          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.arc(x, 80 + (i % 5) * 30, 24, 0, Math.PI * 2);
          ctx.fill();
        }
      } else if (levelNum === 20) {
        ctx.fillStyle = '#0a0a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < 16; i++) {
          const x = ((i * 270) - cameraX * 0.2) % (canvas.width + 270) - 135;
          ctx.fillStyle = '#ff00ff50';
          ctx.fillRect(x, 40, 90, 70);
          ctx.fillStyle = '#ffff0050';
          ctx.fillRect(x + 110, 60, 90, 70);
        }
        for (let i = 0; i < 50; i++) {
          ctx.fillStyle = '#00ffff';
          const x = Math.random() * canvas.width;
          const y = Math.random() * 300;
          ctx.fillRect(x, y, 2, 10);
        }
      } else if (levelNum === 21) {
        ctx.fillStyle = '#0a0a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < 6; i++) {
          const x = ((i * 700) - cameraX * 0.08) % (canvas.width + 700) - 350;
          ctx.fillStyle = '#3a3a5a80';
          ctx.beginPath();
          ctx.arc(x, 120 + (i % 2) * 80, 70, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      ctx.restore();
    }

    function draw() {
      if (!ctx) return;
      
      const level = levels[currentLevel];
      
      ctx.fillStyle = level.bgColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      drawBackground(currentLevel);
      
      ctx.save();
      ctx.translate(-cameraX, 0);
      
      platforms.forEach(plat => {
        ctx.fillStyle = level.groundColor;
        ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
        ctx.fillStyle = '#ffffff20';
        ctx.fillRect(plat.x, plat.y, plat.w, 4);
        ctx.fillStyle = '#00000030';
        ctx.fillRect(plat.x, plat.y + plat.h - 4, plat.w, plat.h - 4);
      });
      
      if (levelEnd) {
        ctx.fillStyle = '#9f7aff';
        ctx.fillRect(levelEnd.x, levelEnd.y, levelEnd.width, levelEnd.height);
        ctx.fillStyle = '#d4bbff';
        ctx.fillRect(levelEnd.x + 5, levelEnd.y + 5, levelEnd.width - 10, levelEnd.height - 10);
        ctx.fillStyle = '#fff';
        ctx.font = '12px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillText('EXIT', levelEnd.x + levelEnd.width/2, levelEnd.y + levelEnd.height/2);
      }
      
      powerUps.forEach(pu => {
        if (!pu.collected) {
          const bobY = Math.sin(Date.now() * 0.005 + pu.x) * 5;
          ctx.fillStyle = pu.color;
          ctx.beginPath();
          ctx.arc(pu.x + 12, pu.y + 12 + bobY, 14, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.beginPath();
          ctx.arc(pu.x + 12, pu.y + 12 + bobY, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = pu.color;
          ctx.font = '10px "Press Start 2P"';
          ctx.textAlign = 'center';
          ctx.fillText('‚úß', pu.x + 12, pu.y + 16 + bobY);
        }
      });
      
      enemies.forEach(enemy => {
        if (enemy.hp > 0) {
          ctx.save();
          ctx.translate(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
          
          if (enemy.type === 'MUSHROOM') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, -8, 10, 0, Math.PI);
            ctx.fill();
            ctx.fillStyle = '#ddaa55';
            ctx.fillRect(-6, 0, 12, 12);
            ctx.fillStyle = '#ffff99';
            ctx.beginPath();
            ctx.arc(-3, -4, 1, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(0, -6, 1, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(3, -4, 1, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'VINE_SPIDER') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, 12, 7, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(-8, -6, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(8, -6, 4, 0, Math.PI * 2);
            ctx.fill();
            for (let i = -1; i <= 1; i++) {
              ctx.strokeStyle = enemy.color;
              ctx.lineWidth = 2;
              ctx.beginPath();
              ctx.moveTo(-10 + i * 10, 8);
              ctx.lineTo(-12 + i * 10, 12);
              ctx.stroke();
              ctx.beginPath();
              ctx.moveTo(10 - i * 10, 8);
              ctx.lineTo(12 - i * 10, 12);
              ctx.stroke();
            }
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(-4, -6, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, -6, 2, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'POISON_WASP') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, -4, 5, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ff9900';
            ctx.fillRect(-4, 0, 8, 6);
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-4, 6, 8, 4);
            ctx.beginPath();
            ctx.ellipse(-8, 0, 6, 8, -0.4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(8, 0, 6, 8, 0.4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, 10);
            ctx.lineTo(2, 14);
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.fillRect(-2, -6, 1, 2);
            ctx.fillRect(1, -6, 1, 2);
          } else if (enemy.type === 'SAND_SCORPION') {
            ctx.scale(enemy.direction, 1);
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, 18, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = enemy.color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(12, 0);
            ctx.quadraticCurveTo(20, -8, 22, -14);
            ctx.stroke();
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(-14, -6, 6, 5, -0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(-14, 6, 6, 5, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.fillRect(-4, -4, 2, 2);
            ctx.fillRect(2, -4, 2, 2);
          } else if (enemy.type === 'HERMIT_CRAB') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, 14, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#993333';
            ctx.beginPath();
            ctx.ellipse(0, 0, 10, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(-14, 4, 6, 5, -0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(14, 4, 6, 5, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = enemy.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-4, -12);
            ctx.lineTo(-4, -16);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(4, -12);
            ctx.lineTo(4, -16);
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-4, -16, 1, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, -16, 1, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'JELLYFISH') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, -8, 12, 12, 0, 0, Math.PI);
            ctx.fill();
            ctx.strokeStyle = enemy.color;
            ctx.lineWidth = 2;
            const wobble = Math.sin(Date.now() * 0.005) * 3;
            for (let i = -1; i <= 1; i++) {
              ctx.beginPath();
              ctx.moveTo(i * 8, 4);
              ctx.quadraticCurveTo(i * 10 + wobble, 12, i * 8, 18);
              ctx.stroke();
            }
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(-4, -8, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, -8, 2, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'SHARK') {
            ctx.scale(enemy.direction, 1);
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, 20, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#2a4a8a';
            ctx.beginPath();
            ctx.moveTo(-8, -8);
            ctx.lineTo(-6, -12);
            ctx.lineTo(-4, -8);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.moveTo(18, 0);
            ctx.lineTo(26, -6);
            ctx.lineTo(26, 6);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(14, -6, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(15, -6, 1.5, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'ICE_GOLEM') {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-10, -24, 20, 18);
            ctx.fillRect(-12, -6, 24, 20);
            ctx.fillRect(-8, 14, 6, 12);
            ctx.fillRect(2, 14, 6, 12);
            ctx.fillStyle = '#5a9fd4';
            ctx.fillRect(-4, -20, 2, 8);
            ctx.fillRect(2, -20, 2, 8);
            ctx.fillStyle = '#fff';
            ctx.fillRect(-6, -18, 3, 3);
            ctx.fillRect(3, -18, 3, 3);
          } else if (enemy.type === 'STONE_GIANT') {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-14, -32, 28, 20);
            ctx.fillRect(-16, -12, 32, 24);
            ctx.fillRect(-10, 12, 8, 16);
            ctx.fillRect(2, 12, 8, 16);
            ctx.strokeStyle = '#505050';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-8, -28);
            ctx.lineTo(0, -20);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(8, -28);
            ctx.lineTo(0, -20);
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.fillRect(-8, -24, 4, 4);
            ctx.fillRect(4, -24, 4, 4);
          } else if (enemy.type === 'FIRE_ELEMENTAL') {
            const flames = Math.sin(Date.now() * 0.005 + enemy.x) * 4;
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, 0, 12 + flames, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ffaa00';
            ctx.beginPath();
            ctx.arc(0, 0, 8 + flames * 0.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(-4, -4, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, -4, 3, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'LAVA_BLOB') {
            const wobble = Math.sin(Date.now() * 0.003 + enemy.x) * 3;
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, 0, 12 + wobble, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ffaa00';
            ctx.beginPath();
            ctx.arc(0, 0, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-4, -4, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, -4, 2, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'SKY_SPRITE') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, 0, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(-10, 0, 6, 10, -0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(10, 0, 6, 10, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillRect(-2, -2, 1, 1);
            ctx.fillRect(1, -2, 1, 1);
          } else if (enemy.type === 'FROG') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(-6, -4, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(6, -4, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(0, 2, 8, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(-10, 8, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(10, 8, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.fillRect(-8, -6, 2, 2);
            ctx.fillRect(6, -6, 2, 2);
          } else if (enemy.type === 'FISH') {
            ctx.scale(enemy.direction, 1);
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, 14, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ff8844';
            ctx.beginPath();
            ctx.arc(-10, 0, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.moveTo(12, 0);
            ctx.lineTo(20, -5);
            ctx.lineTo(20, 5);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(6, -4, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(7, -4, 1, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'SQUIRREL') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, -4, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillRect(-4, 0, 8, 12);
            ctx.fillRect(-3, 12, 3, 8);
            ctx.fillRect(0, 12, 3, 8);
            ctx.strokeStyle = enemy.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(8, -8);
            ctx.quadraticCurveTo(20, -15, 16, -4);
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.fillRect(-3, -6, 1, 1);
            ctx.fillRect(2, -6, 1, 1);
          } else if (enemy.type === 'PLANT') {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-4, 0, 8, 16);
            for (let i = 0; i < 3; i++) {
              ctx.beginPath();
              ctx.arc(-8 + i * 8, -4, 6, 0, Math.PI * 2);
              ctx.fill();
            }
            ctx.fillStyle = '#228b22';
            ctx.fillRect(-2, -20, 4, 8);
          } else if (enemy.type === 'ZOMBIE') {
            ctx.scale(enemy.direction, 1);
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-8, -20, 16, 18);
            ctx.fillRect(-10, -2, 20, 18);
            ctx.fillRect(-6, 16, 4, 12);
            ctx.fillRect(2, 16, 4, 12);
            ctx.fillStyle = '#aaaaaa';
            ctx.fillRect(-8, -20, 2, 18);
            ctx.fillStyle = '#000';
            ctx.fillRect(-6, -16, 2, 2);
            ctx.fillRect(4, -16, 2, 2);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(-4, -14, 2, 2);
            ctx.fillRect(2, -14, 2, 2);
          } else if (enemy.type === 'GHOST') {
            ctx.fillStyle = enemy.color + '80';
            ctx.beginPath();
            ctx.arc(0, -8, 12, 0, Math.PI);
            ctx.fill();
            ctx.fillRect(-12, -8, 24, 14);
            for (let i = -1; i <= 1; i++) {
              ctx.beginPath();
              ctx.arc(-8 + i * 8, 6, 4, 0, Math.PI * 2);
              ctx.fill();
            }
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-6, -10, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(6, -10, 3, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'STORM_ELEMENTAL') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, 0, 14, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-8, -8);
            ctx.lineTo(0, 0);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(8, -8);
            ctx.lineTo(0, 0);
            ctx.stroke();
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(-5, -8, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(5, -8, 2, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'LEPRECHAUN') {
            ctx.fillStyle = '#228b22';
            ctx.fillRect(-6, -8, 12, 12);
            ctx.fillStyle = '#ffdd88';
            ctx.beginPath();
            ctx.arc(0, -12, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#228b22';
            ctx.fillRect(-8, -10, 4, 6);
            ctx.fillStyle = '#ffdd88';
            ctx.fillRect(-2, -10, 4, 6);
            ctx.fillStyle = '#000';
            ctx.fillRect(-3, -14, 1, 1);
            ctx.fillRect(2, -14, 1, 1);
          } else if (enemy.type === 'STAR') {
            ctx.fillStyle = enemy.color;
            for (let i = 0; i < 5; i++) {
              const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
              const x = Math.cos(angle) * 10;
              const y = Math.sin(angle) * 10;
              if (i === 0) ctx.beginPath();
              if (i === 0) ctx.moveTo(x, y);
              else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(0, -2, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(-4, 2, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, 2, 2, 0, Math.PI * 2);
            ctx.fill();
          } else if (enemy.type === 'ALIEN') {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-10, -8, 20, 18);
            ctx.beginPath();
            ctx.arc(-8, -10, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(8, -10, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-8, -10, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(8, -10, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(-4, 0, 2, 8);
            ctx.fillRect(2, 0, 2, 8);
          } else if (enemy.type === 'NEON_MONSTER') {
            ctx.strokeStyle = enemy.color;
            ctx.lineWidth = 3;
            ctx.fillStyle = enemy.color + '50';
            ctx.beginPath();
            ctx.arc(0, 0, 14, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(-6, -8, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(6, -8, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = enemy.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-10, 4);
            ctx.lineTo(-14, 8);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(10, 4);
            ctx.lineTo(14, 8);
            ctx.stroke();
          } else if (enemy.type === 'SHADOW_KNIGHT') {
            ctx.scale(enemy.direction, 1);
            ctx.fillStyle = enemy.color;
            ctx.fillRect(-14, -20, 28, 24);
            ctx.fillRect(-16, 4, 32, 16);
            ctx.fillRect(-8, 20, 6, 12);
            ctx.fillRect(2, 20, 6, 12);
            ctx.fillStyle = '#555';
            ctx.fillRect(14, -8, 4, 24);
            ctx.fillStyle = '#aaa';
            ctx.fillRect(12, -10, 8, 4);
            ctx.fillStyle = '#1a1a3e';
            ctx.fillRect(-6, -14, 4, 4);
            ctx.fillRect(2, -14, 4, 4);
          } else if (enemy.type === 'BAT') {
            ctx.fillStyle = enemy.color;
            ctx.beginPath();
            ctx.arc(0, 0, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(-12, 0, 8, 12, -0.4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(12, 0, 8, 12, 0.4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#4a2a0a';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-4, 2);
            ctx.lineTo(-6, 6);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(4, 2);
            ctx.lineTo(6, 6);
            ctx.stroke();
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(-2, -2, 1, 1);
            ctx.fillRect(1, -2, 1, 1);
          }
          
          if (enemy.maxHp > 1) {
            const barWidth = enemy.width;
            const barHeight = 4;
            const barX = -barWidth / 2;
            const barY = -enemy.height / 2 - 12;
            
            ctx.fillStyle = '#333';
            ctx.fillRect(barX, barY, barWidth, barHeight);
            
            const hpPercent = enemy.hp / enemy.maxHp;
            ctx.fillStyle = hpPercent > 0.5 ? '#00ff00' : hpPercent > 0.25 ? '#ffff00' : '#ff0000';
            ctx.fillRect(barX, barY, barWidth * hpPercent, barHeight);
            
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 1;
            ctx.strokeRect(barX, barY, barWidth, barHeight);
          }
          
          ctx.restore();
        }
      });
      
      projectiles.forEach(proj => {
        if (proj.type === 'fireball') {
          ctx.fillStyle = proj.color + '80';
          ctx.beginPath();
          ctx.ellipse(proj.x + proj.width/2, proj.y + proj.height/2, proj.width/2 + 4, proj.height/2 + 4, 0, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = proj.color;
          ctx.beginPath();
          ctx.ellipse(proj.x + proj.width/2, proj.y + proj.height/2, proj.width/2, proj.height/2, 0, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = '#ff0';
          ctx.beginPath();
          ctx.arc(proj.x + proj.width/2, proj.y + proj.height/2, proj.width/4, 0, Math.PI * 2);
          ctx.fill();
        } else if (proj.type === 'ice') {
          ctx.fillStyle = proj.color;
          ctx.beginPath();
          ctx.moveTo(proj.x + proj.width/2, proj.y);
          ctx.lineTo(proj.x + proj.width, proj.y + proj.height/2);
          ctx.lineTo(proj.x + proj.width/2, proj.y + proj.height);
          ctx.lineTo(proj.x, proj.y + proj.height/2);
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 1;
          ctx.stroke();
        } else if (proj.type === 'bubble') {
          ctx.fillStyle = proj.color + '60';
          ctx.beginPath();
          ctx.arc(proj.x + proj.width/2, proj.y + proj.height/2, proj.width/2, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = proj.color;
          ctx.lineWidth = 1.5;
          ctx.stroke();
        } else if (proj.type === 'earth') {
          ctx.fillStyle = proj.color;
          ctx.beginPath();
          ctx.moveTo(proj.x, proj.y);
          ctx.lineTo(proj.x + proj.width/2, proj.y - proj.height/2);
          ctx.lineTo(proj.x + proj.width, proj.y);
          ctx.lineTo(proj.x + proj.width/2, proj.y + proj.height/2);
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle = '#6b5a4a';
          ctx.lineWidth = 1;
          ctx.stroke();
        } else if (proj.type === 'lightning') {
          ctx.strokeStyle = proj.color;
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(proj.x, proj.y);
          ctx.lineTo(proj.x + proj.vx * 0.5, proj.y + proj.vy * 0.5);
          ctx.stroke();
          
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      });
      
      const flashOn = player.invincible > 0 && Math.floor(player.invincible / 4) % 2 === 0;
      if (!flashOn) {
        ctx.fillStyle = '#4a90d9';
        ctx.fillRect(player.x + 4, player.y + 12, 24, 20);
        
        ctx.fillStyle = '#ffd4a3';
        ctx.fillRect(player.x + 6, player.y, 20, 16);
        
        ctx.fillStyle = '#000';
        ctx.fillRect(player.x + (player.facing > 0 ? 18 : 10), player.y + 6, 4, 4);
        
        ctx.fillStyle = '#2d5a87';
        ctx.fillRect(player.x + 6, player.y + 32, 8, 8);
        ctx.fillRect(player.x + 18, player.y + 32, 8, 8);
        
        if (player.powerUp) {
          ctx.strokeStyle = PowerUpTypes[player.powerUp].color;
          ctx.lineWidth = 2;
          ctx.strokeRect(player.x - 2, player.y - 2, player.width + 4, player.height + 4);
        }
        
        if (player.attacking) {
          ctx.fillStyle = player.powerUp ? PowerUpTypes[player.powerUp].color : '#fff';
          ctx.fillRect(player.x + (player.facing > 0 ? player.width : -30), player.y + 10, 30, 6);
        }
      }
      
      particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 40;
        ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
        ctx.globalAlpha = 1;
      });
      
      ctx.restore();
    }

    // Event Listeners
    document.addEventListener('keydown', (e) => {
      keys[e.code] = true;
      if (['ArrowUp', 'ArrowDown', 'Space'].includes(e.code)) {
        e.preventDefault();
      }
    });

    document.addEventListener('keyup', (e) => {
      keys[e.code] = false;
    });

    function createTouchControls() {
      if ('ontouchstart' in window) {
        const controls = document.createElement('div');
        controls.innerHTML = `
          <div class="fixed bottom-4 left-4 flex gap-2 z-50">
            <button id="touch-left" class="w-16 h-16 rounded-full bg-white/30 flex items-center justify-center text-2xl select-none">‚Üê</button>
            <button id="touch-right" class="w-16 h-16 rounded-full bg-white/30 flex items-center justify-center text-2xl select-none">‚Üí</button>
          </div>
          <div class="fixed bottom-4 right-4 flex gap-2 z-50">
            <button id="touch-attack" class="w-16 h-16 rounded-full bg-red-500/50 flex items-center justify-center text-2xl select-none">X</button>
            <button id="touch-jump" class="w-16 h-16 rounded-full bg-blue-500/50 flex items-center justify-center text-2xl select-none">‚Üë</button>
          </div>
        `;
        document.body.appendChild(controls);
        
        const addTouchListeners = (id, keyCode) => {
          const el = document.getElementById(id);
          el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[keyCode] = true; });
          el.addEventListener('touchend', (e) => { e.preventDefault(); keys[keyCode] = false; });
        };
        
        addTouchListeners('touch-left', 'ArrowLeft');
        addTouchListeners('touch-right', 'ArrowRight');
        addTouchListeners('touch-jump', 'ArrowUp');
        addTouchListeners('touch-attack', 'KeyX');
      }
    }

    createTouchControls();
    render();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cf1752b568dacdb',t:'MTc3MTI5MTE3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>